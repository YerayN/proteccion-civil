<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles.css">
    <script src="../auth.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <title>Inicio - Protección Civil</title>
</head>

<body onload="checkAuth()">
    <header>
        <input type="checkbox" id="menuToggle" class="menu-checkbox">
        <label for="menuToggle" class="menu-icon">&#9776; Menú</label>
        <nav id="navbar" class="navbar">
            <ul>
                <li><a href="../index.html">Inicio</a></li>
                <li><a href="../documentos.html">Documentos</a></li>
                <li><a href="../formacion.html">Formación</a></li>
                <li><a href="../contacto.html">Contacto</a></li>
            </ul>
        </nav>
        <div class="logout-container">
            <button onclick="logout()" class="logout-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-logout" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffffff" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
                    <path d="M9 12h12l-3 -3" />
                    <path d="M18 15l3 -3" />
                </svg>
                Salir
            </button>
        </div>
    </header>

    <main class="formulario-main">
        <div class="panel">
            <h2>Generar Informe</h2>
            <form id="informe-form">
                <div class="form-group">
                    <label for="categoria">Categoría:</label>
                    <select id="categoria" name="categoria" required onchange="mostrarFormulario()">
                        <option value="">Seleccione una categoría</option>
                        <option value="sanitaria">Sanitaria</option>
                        <option value="incendio">Incendio</option>
                        <option value="trafico">Tráfico</option>
                        <option value="ayuda_social">Ayuda Social</option>
                        <option value="proteccion_animal">Protección Animal</option>
                    </select>
                </div>

                <!-- Formularios específicos por categoría -->
                <div id="formulario-sanitaria" class="formulario-categoria seccion-oculta">
                    <div class="form-group">
                        <label for="nombre-paciente">Nombre del paciente:</label>
                        <input type="text" id="nombre-paciente" name="nombre-paciente">
                    </div>
                    <div class="form-group">
                        <label for="motivo-intervencion">Motivo de la intervención:</label>
                        <input type="text" id="motivo-intervencion" name="motivo-intervencion">
                    </div>
                    <div class="form-group">
                        <label for="estado-paciente">Estado del paciente:</label>
                        <input type="text" id="estado-paciente" name="estado-paciente">
                    </div>
                    <div class="form-group">
                        <label for="primeros-auxilios">Primeros auxilios aplicados:</label>
                        <input type="text" id="primeros-auxilios" name="primeros-auxilios">
                    </div>
                    <div class="form-group">
                        <label for="traslado">Traslado:</label>
                        <input type="text" id="traslado" name="traslado">
                    </div>
                </div>

                <div id="formulario-incendio" class="formulario-categoria seccion-oculta">
                    <div class="form-group">
                        <label for="tipo-incendio">Tipo de incendio:</label>
                        <select id="tipo-incendio" name="tipo-incendio" required>
                            <option value="forestal">Forestal</option>
                            <option value="urbano">Urbano</option>
                            <option value="vehiculo">Vehículo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="intervencion-realizada">Intervención realizada:</label>
                        <input type="text" id="intervencion-realizada" name="intervencion-realizada">
                    </div>
                    <div class="form-group">
                        <label for="recursos-empleados">Recursos empleados:</label>
                        <input type="text" id="recursos-empleados" name="recursos-empleados">
                    </div>
                    <div class="form-group">
                        <label for="conclusion">Conclusión:</label>
                        <input type="text" id="conclusion" name="conclusion">
                    </div>
                </div>

                <div id="formulario-trafico" class="formulario-categoria seccion-oculta">
                    <div class="form-group">
                        <label for="tipo-intervencion-trafico">Tipo de intervención:</label>
                        <select id="tipo-intervencion-trafico" name="tipo-intervencion-trafico" required>
                            <option value="regulacion">Regulación de tráfico</option>
                            <option value="apoyo-accidente">Apoyo en accidente</option>
                            <option value="vehiculo-averiado">Vehículo averiado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="causa-incidente">Causa del incidente:</label>
                        <input type="text" id="causa-incidente" name="causa-incidente">
                    </div>
                    <div class="form-group">
                        <label for="medidas-apoyo-trafico">Medidas de apoyo realizadas:</label>
                        <input type="text" id="medidas-apoyo-trafico" name="medidas-apoyo-trafico">
                    </div>
                </div>

                <div id="formulario-ayuda-social" class="formulario-categoria seccion-oculta">
                    <div class="form-group">
                        <label for="tipo-intervencion-social">Tipo de intervención social:</label>
                        <input type="text" id="tipo-intervencion-social" name="tipo-intervencion-social" required>
                    </div>
                    <div class="form-group">
                        <label for="beneficiarios">Beneficiario/s:</label>
                        <input type="text" id="beneficiarios" name="beneficiarios">
                    </div>
                    <div class="form-group">
                        <label for="medidas-apoyo-social">Medidas de apoyo realizadas:</label>
                        <input type="text" id="medidas-apoyo-social" name="medidas-apoyo-social">
                    </div>
                    <div class="form-group">
                        <label for="recursos-materiales-social">Recursos y materiales utilizados:</label>
                        <input type="text" id="recursos-materiales-social" name="recursos-materiales-social">
                    </div>
                </div>

                <div id="formulario-proteccion-animal" class="formulario-categoria seccion-oculta">
                    <div class="form-group">
                        <label for="tipo-intervencion-animal">Tipo de intervención:</label>
                        <input type="text" id="tipo-intervencion-animal" name="tipo-intervencion-animal" required>
                    </div>
                    <div class="form-group">
                        <label for="tipo-animal">Tipo de animal:</label>
                        <input type="text" id="tipo-animal" name="tipo-animal" required>
                    </div>
                    <div class="form-group">
                        <label for="medidas-apoyo-animal">Medidas de apoyo realizadas:</label>
                        <input type="text" id="medidas-apoyo-animal" name="medidas-apoyo-animal" required>
                    </div>
                    <div class="form-group">
                        <label for="recursos-materiales-animal">Recursos y materiales utilizados:</label>
                        <input type="text" id="recursos-materiales-animal" name="recursos-materiales-animal">
                    </div>
                    <div class="form-group">
                        <label for="traslado-animal">Traslado:</label>
                        <input type="text" id="traslado-animal" name="traslado-animal">
                    </div>
                </div>

                <!-- Campos comunes -->
                <div class="form-group">
                    <label for="titulo">Título Informe:</label>
                    <input type="text" id="titulo" name="titulo" required>
                </div>
                <div class="form-group">
                    <label for="voluntario">Voluntario:</label>
                    <input type="text" id="voluntario" name="voluntario" required>
                </div>
                <div class="form-group">
                    <label for="vehiculo">Vehículo Utilizado:</label>
                    <select id="vehiculo" name="vehiculo" required>
                        <option value="vehiculo1">Vehículo 1</option>
                        <option value="vehiculo2">Vehículo 2</option>
                        <option value="vehiculo3">Vehículo 3</option>
                        <option value="vehiculo4">Vehículo 4</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fecha-hora">Fecha y Hora:</label>
                    <input type="datetime-local" id="fecha-hora" name="fecha-hora" required>
                </div>
                <div class="form-group">
                    <label for="hora-fin">Hora de Fin:</label>
                    <input type="time" id="hora-fin" name="hora-fin" required>
                </div>
                <div class="form-group">
                    <label for="solicitante">Solicitante:</label>
                    <input type="text" id="solicitante" name="solicitante">
                </div>
                <div class="form-group">
                    <label for="cooperacion">Cooperación con otras entidades:</label>
                    <input type="text" id="cooperacion" name="cooperacion">
                </div>

                <button type="submit">Generar y Enviar</button>
            </form>
        </div>
    </main>

    <script>
        function mostrarFormulario() {
            const categoria = document.getElementById('categoria').value;
            const formularios = document.querySelectorAll('.formulario-categoria');

            formularios.forEach(formulario => {
                formulario.classList.add('seccion-oculta');
            });

            if (categoria) {
                document.getElementById(`formulario-${categoria}`).classList.remove('seccion-oculta');
            }
        }

        document.getElementById('informe-form').addEventListener('submit', async function (event) {
            event.preventDefault(); // Evita el envío normal del formulario

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const titulo = document.getElementById('titulo').value;
            const voluntario = document.getElementById('voluntario').value;
            const vehiculo = document.getElementById('vehiculo').value;
            const fechaHoraRaw = document.getElementById('fecha-hora').value;
            const horaFin = document.getElementById('hora-fin').value;
            const solicitante = document.getElementById('solicitante').value;
            const cooperacion = document.getElementById('cooperacion').value;
            const categoria = document.getElementById('categoria').value;

            // Formatear la fecha y hora
            const fecha = new Date(fechaHoraRaw);
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0'); // Los meses van de 0 a 11
            const ano = fecha.getFullYear();
            const hora = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            const fechaHoraFormateada = `${dia}-${mes}-${ano}_${hora}:${minutos}`;

            // Aquí generas el contenido del PDF basado en el formulario
            doc.text(20, 20, `Título: ${titulo}`);
            doc.text(20, 30, `Voluntario: ${voluntario}`);
            doc.text(20, 40, `Vehículo Utilizado: ${vehiculo}`);
            doc.text(20, 50, `Fecha y Hora: ${fechaHoraFormateada}`);
            doc.text(20, 60, `Hora de Fin: ${horaFin}`);
            doc.text(20, 70, `Solicitante: ${solicitante}`);
            doc.text(20, 80, `Cooperación con otras entidades: ${cooperacion}`);
            doc.text(20, 90, `Categoría: ${categoria}`);

            // Añadir preguntas específicas según la categoría seleccionada
            if (categoria === 'sanitaria') {
                const nombrePaciente = document.getElementById('nombre-paciente').value;
                const motivoIntervencion = document.getElementById('motivo-intervencion').value;
                const estadoPaciente = document.getElementById('estado-paciente').value;
                const primerosAuxilios = document.getElementById('primeros-auxilios').value;
                const traslado = document.getElementById('traslado').value;

                doc.text(20, 100, `Nombre del Paciente: ${nombrePaciente}`);
                doc.text(20, 110, `Motivo de la Intervención: ${motivoIntervencion}`);
                doc.text(20, 120, `Estado del Paciente: ${estadoPaciente}`);
                doc.text(20, 130, `Primeros Auxilios Aplicados: ${primerosAuxilios}`);
                doc.text(20, 140, `Traslado: ${traslado}`);
            } else if (categoria === 'incendio') {
                const tipoIncendio = document.getElementById('tipo-incendio').value;
                const intervencionRealizada = document.getElementById('intervencion-realizada').value;
                const recursosEmpleados = document.getElementById('recursos-empleados').value;
                const conclusion = document.getElementById('conclusion').value;

                doc.text(20, 100, `Tipo de Incendio: ${tipoIncendio}`);
                doc.text(20, 110, `Intervención Realizada: ${intervencionRealizada}`);
                doc.text(20, 120, `Recursos Empleados: ${recursosEmpleados}`);
                doc.text(20, 130, `Conclusión: ${conclusion}`);
            } else if (categoria === 'trafico') {
                const tipoIntervencionTrafico = document.getElementById('tipo-intervencion-trafico').value;
                const causaIncidente = document.getElementById('causa-incidente').value;
                const medidasApoyoTrafico = document.getElementById('medidas-apoyo-trafico').value;

                doc.text(20, 100, `Tipo de Intervención: ${tipoIntervencionTrafico}`);
                doc.text(20, 110, `Causa del Incidente: ${causaIncidente}`);
                doc.text(20, 120, `Medidas de Apoyo Realizadas: ${medidasApoyoTrafico}`);
            } else if (categoria === 'ayuda_social') {
                const tipoIntervencionSocial = document.getElementById('tipo-intervencion-social').value;
                const beneficiarios = document.getElementById('beneficiarios').value;
                const medidasApoyoSocial = document.getElementById('medidas-apoyo-social').value;
                const recursosMaterialesSocial = document.getElementById('recursos-materiales-social').value;

                doc.text(20, 100, `Tipo de Intervención Social: ${tipoIntervencionSocial}`);
                doc.text(20, 110, `Beneficiario/s: ${beneficiarios}`);
                doc.text(20, 120, `Medidas de Apoyo Realizadas: ${medidasApoyoSocial}`);
                doc.text(20, 130, `Recursos y Materiales Utilizados: ${recursosMaterialesSocial}`);
            } else if (categoria === 'proteccion_animal') {
                const tipoIntervencionAnimal = document.getElementById('tipo-intervencion-animal').value;
                const tipoAnimal = document.getElementById('tipo-animal').value;
                const medidasApoyoAnimal = document.getElementById('medidas-apoyo-animal').value;
                const recursosMaterialesAnimal = document.getElementById('recursos-materiales-animal').value;
                const trasladoAnimal = document.getElementById('traslado-animal').value;

                doc.text(20, 100, `Tipo de Intervención: ${tipoIntervencionAnimal}`);
                doc.text(20, 110, `Tipo de Animal: ${tipoAnimal}`);
                doc.text(20, 120, `Medidas de Apoyo Realizadas: ${medidasApoyoAnimal}`);
                doc.text(20, 130, `Recursos y Materiales Utilizados: ${recursosMaterialesAnimal}`);
                doc.text(20, 140, `Traslado: ${trasladoAnimal}`);
            }

            // Generar el PDF como un blob
            const pdfBlob = doc.output('blob');

            // Crear un FormData para enviar el PDF al servidor
            const formData = new FormData();
            formData.append('titulo', titulo);
            formData.append('voluntario', voluntario);
            formData.append('vehiculo', vehiculo);
            formData.append('fecha-hora', fechaHoraFormateada);
            formData.append('hora-fin', horaFin);
            formData.append('solicitante', solicitante);
            formData.append('cooperacion', cooperacion);
            formData.append('categoria', categoria);
            formData.append('pdf', pdfBlob, 'informe.pdf');

            // Enviar el PDF generado al backend
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Informe subido correctamente: ' + result.fileId);
                } else {
                    console.error('Error al subir el informe:', result.message);
                    alert('Error al subir el informe');
                }
            } catch (error) {
                console.error('Error en la solicitud:', error);
                alert('Error al subir el informe');
            }
        });
    </script>
</body>

</html>
